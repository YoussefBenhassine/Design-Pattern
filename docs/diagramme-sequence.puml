@startuml Diagramme de Séquence - Réservation Complète via Interface Graphique

actor "Utilisateur" as User
participant "MainWindow" as UI
participant "ReservationPanel" as ResPanel
participant "ReservationFacade" as Facade
participant "ReservationService" as ResService
participant "ReservationBuilder" as Builder
participant "ReservationRepository" as ResRepo
participant "PaymentService" as PayService
participant "PaymentStrategy" as Strategy
participant "PaymentRepository" as PayRepo
participant "NotificationService" as NotifService
participant "EmailObserver" as EmailObs
participant "SMSObserver" as SMSObs
participant "InAppObserver" as InAppObs

User -> UI: Ouvrir l'application
activate UI
UI -> UI: Initialiser les données de démo
UI -> UI: Afficher l'interface avec onglets
UI --> User: Interface graphique affichée

User -> ResPanel: Sélectionner onglet "Réserver"
activate ResPanel
User -> ResPanel: Remplir le formulaire de réservation
User -> ResPanel: Cliquer sur "Réserver"
ResPanel -> Facade: completeReservation(clientId, serviceId, prestataireId, dateTime, paymentMethod, details)

activate Facade

Facade -> ResService: createReservation(...)
activate ResService

ResService -> Builder: new ReservationBuilder()
activate Builder
ResService -> Builder: withClientId(...)
ResService -> Builder: withServiceId(...)
ResService -> Builder: withPrestataireId(...)
ResService -> Builder: withDateTime(...)
ResService -> Builder: withTotalAmount(...)
ResService -> Builder: build()
Builder --> ResService: Reservation
deactivate Builder

ResService -> ResRepo: save(reservation)
activate ResRepo
ResRepo --> ResService: Reservation
deactivate ResRepo

ResService -> NotifService: sendReservationConfirmation(clientId, reservationId)
activate NotifService
NotifService -> NotifService: sendNotification(..., EMAIL)
NotifService -> EmailObs: update(notification)
activate EmailObs
EmailObs --> NotifService: OK
deactivate EmailObs
NotifService -> NotifService: sendNotification(..., IN_APP)
NotifService -> InAppObs: update(notification)
activate InAppObs
InAppObs --> NotifService: OK
deactivate InAppObs
NotifService --> ResService: OK
deactivate NotifService

ResService --> Facade: Reservation
deactivate ResService

Facade -> Facade: getPaymentStrategy(paymentMethod)
Facade -> PayService: setPaymentStrategy(strategy)
activate PayService
PayService --> Facade: OK
deactivate PayService

Facade -> PayService: processPayment(reservationId, amount, method, details)
activate PayService
PayService -> Strategy: processPayment(amount, details)
activate Strategy
Strategy --> PayService: true
deactivate Strategy
PayService -> PayRepo: save(payment)
activate PayRepo
PayRepo --> PayService: Payment
deactivate PayRepo
PayService --> Facade: Payment
deactivate PayService

alt Payment réussi
    Facade -> NotifService: sendPaymentConfirmation(clientId, paymentId)
    activate NotifService
    NotifService -> NotifService: sendNotification(..., EMAIL)
    NotifService -> EmailObs: update(notification)
    activate EmailObs
    EmailObs --> NotifService: OK
    deactivate EmailObs
    NotifService -> NotifService: sendNotification(..., SMS)
    NotifService -> SMSObs: update(notification)
    activate SMSObs
    SMSObs --> NotifService: OK
    deactivate SMSObs
    NotifService --> Facade: OK
    deactivate NotifService
    Facade --> ResPanel: Reservation
    ResPanel -> ResPanel: Afficher le résultat dans JTextArea
    ResPanel --> User: Message de succès affiché
else Payment échoué
    Facade -> ResService: cancelReservation(reservationId)
    Facade --> ResPanel: Exception
    ResPanel -> ResPanel: Afficher message d'erreur
    ResPanel --> User: Message d'erreur affiché
end

deactivate Facade
deactivate ResPanel
deactivate UI

@enduml

